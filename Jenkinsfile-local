pipeline {
    agent any

    options {
        timestamps()
        ansiColor('xterm')
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '5'))
        skipDefaultCheckout(true)
    }

    parameters {
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: false,
            description: 'Ejecutar tests antes del build'
        )
        booleanParam(
            name: 'CLEAN_BUILD',
            defaultValue: false,
            description: 'Eliminar node_modules y hacer instalación limpia antes de los tests'
        )
        string(
            name: 'CUSTOM_API_URL',
            defaultValue: '',
            description: 'URL del backend API. Si está vacío se usa el valor por defecto.'
        )
        string(
            name: 'CUSTOM_FRONTEND_URL',
            defaultValue: '',
            description: 'URL pública del frontend (solo informativa / logs).'
        )
        string(
            name: 'CUSTOM_PORT',
            defaultValue: '',
            description: 'Puerto en el host para exponer el frontend. Default 5174.'
        )
        string(
            name: 'CUSTOM_NETWORK',
            defaultValue: '',
            description: 'Red Docker para conectar el contenedor. Default marketplace_link_mplink_net.'
        )
    }

    environment {
        // Defaults efectivos del despliegue
        VITE_API_URL      = "${params.CUSTOM_API_URL ?: 'http://marketplace-link-back:8080'}"
        VITE_FRONTEND_URL = "${params.CUSTOM_FRONTEND_URL ?: 'http://localhost:5174'}"
        FRONT_PORT        = "${params.CUSTOM_PORT ?: '5174'}"
        DOCKER_NETWORK    = "${params.CUSTOM_NETWORK ?: 'marketplace_link_mplink_net'}"

        DOCKER_IMAGE      = 'marketplace-frontend-local'
        DOCKER_TAG        = "${env.BUILD_NUMBER}"
        CONTAINER_NAME    = 'marketplace_frontend'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm

                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()

                    echo "Commit: ${env.GIT_COMMIT_SHORT}"
                    echo "VITE_API_URL: ${env.VITE_API_URL}"
                    echo "VITE_FRONTEND_URL: ${env.VITE_FRONTEND_URL}"
                    echo "FRONT_PORT: ${env.FRONT_PORT}"
                    echo "DOCKER_NETWORK: ${env.DOCKER_NETWORK}"
                }
            }
        }

        stage('Tests (opcional)') {
            when {
                expression { params.RUN_TESTS }
            }
            steps {
                script {
                    sh '''
                        if [ "${CLEAN_BUILD}" = "true" ]; then
                          rm -rf node_modules package-lock.json
                        fi

                        if [ ! -d node_modules ]; then
                          npm ci || npm install
                        fi

                        npm test || echo "Tests fallaron, se continúa igualmente"
                    '''
                }
            }
        }

        stage('Detener contenedor anterior') {
            steps {
                script {
                    sh """
                        docker stop ${env.CONTAINER_NAME} 2>/dev/null || echo "Sin contenedor en ejecución"
                        docker rm   ${env.CONTAINER_NAME} 2>/dev/null || echo "Sin contenedor que remover"
                    """
                }
            }
        }

        stage('Build imagen Docker') {
            steps {
                script {
                    def buildDate = sh(
                        script: 'date "+%Y-%m-%d %H:%M:%S"',
                        returnStdout: true
                    ).trim()

                    sh """
                        docker build \
                          --build-arg BUILD_DATE="${buildDate}" \
                          --build-arg GIT_COMMIT="${env.GIT_COMMIT_SHORT}" \
                          --build-arg VERSION="${env.BUILD_NUMBER}" \
                          --build-arg VITE_API_URL="${env.VITE_API_URL}" \
                          --build-arg VITE_FRONTEND_URL="${env.VITE_FRONTEND_URL}" \
                          -t ${env.DOCKER_IMAGE}:${env.DOCKER_TAG} \
                          -t ${env.DOCKER_IMAGE}:latest \
                          .
                    """
                }
            }
        }

        stage('Desplegar contenedor') {
            steps {
                script {
                    sh """
                        docker run -d \
                          --name ${env.CONTAINER_NAME} \
                          --network ${env.DOCKER_NETWORK} \
                          -p ${env.FRONT_PORT}:80 \
                          -e VITE_API_URL=${env.VITE_API_URL} \
                          -e VITE_FRONTEND_URL=${env.VITE_FRONTEND_URL} \
                          --label "com.docker.compose.project=marketplace_link" \
                          --restart unless-stopped \
                          ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}
                    """
                }
            }
        }

        stage('Verificación') {
            steps {
                script {
                    sleep 3

                    def status = sh(
                        script: "docker ps --filter name=${env.CONTAINER_NAME} --format '{{.Status}}'",
                        returnStdout: true
                    ).trim()

                    if (!status.contains('Up')) {
                        error "El contenedor no está corriendo. Status: ${status}"
                    }

                    echo "Contenedor en ejecución: ${status}"

                    sh "docker logs --tail=50 ${env.CONTAINER_NAME} || true"

                    sh """
                        docker exec ${env.CONTAINER_NAME} cat /usr/share/nginx/html/config.js || echo "No se pudo leer config.js"
                    """
                }
            }
        }
    }

    post {
        success {
            script {
                echo "Despliegue completado correctamente."
                echo "Frontend:  http://localhost:${env.FRONT_PORT}"
                echo "API URL:   ${env.VITE_API_URL}"
                echo "Imagen:    ${env.DOCKER_IMAGE}:${env.DOCKER_TAG}"
                echo "Contenedor:${env.CONTAINER_NAME}"
            }
        }
        failure {
            script {
                echo "Despliegue fallido. Revisar logs."
                sh "docker logs ${env.CONTAINER_NAME} 2>/dev/null || echo 'Sin logs del contenedor'"
            }
        }
        cleanup {
            script {
                sh "docker image prune -f 2>/dev/null || true"
            }
        }
    }
}
